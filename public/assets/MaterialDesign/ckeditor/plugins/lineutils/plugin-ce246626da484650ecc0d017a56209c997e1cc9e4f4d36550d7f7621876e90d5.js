!function(){function t(t,e){CKEDITOR.tools.extend(this,{editor:t,editable:t.editable(),doc:t.document,win:t.window},e,!0),this.inline=this.editable.isInline(),this.inline||(this.frame=this.win.getFrame()),this.target=this[this.inline?"editable":"doc"]}function e(t,e){CKEDITOR.tools.extend(this,e,{editor:t},!0)}function i(t,e){var i=t.editable();CKEDITOR.tools.extend(this,{editor:t,editable:i,inline:i.isInline(),doc:t.document,win:t.window,container:CKEDITOR.document.getBody(),winTop:CKEDITOR.document.getWindow()},e,!0),this.hidden={},this.visible={},this.inline||(this.frame=this.win.getFrame()),this.queryViewport();var n=CKEDITOR.tools.bind(this.queryViewport,this),r=CKEDITOR.tools.bind(this.hideVisible,this),l=CKEDITOR.tools.bind(this.removeAll,this);i.attachListener(this.winTop,"resize",n),i.attachListener(this.winTop,"scroll",n),i.attachListener(this.winTop,"resize",r),i.attachListener(this.win,"scroll",r),i.attachListener(this.inline?i:this.frame,"mouseout",function(t){var e=t.data.$.clientX;t=t.data.$.clientY,this.queryViewport(),(e<=this.rect.left||e>=this.rect.right||t<=this.rect.top||t>=this.rect.bottom)&&this.hideVisible(),(0>=e||e>=this.winTopPane.width||0>=t||t>=this.winTopPane.height)&&this.hideVisible()},this),i.attachListener(t,"resize",n),i.attachListener(t,"mode",l),t.on("destroy",l),this.lineTpl=new CKEDITOR.template('<div data-cke-lineutils-line="1" class="cke_reset_all" style="{lineStyle}"><span style="{tipLeftStyle}">&nbsp;</span><span style="{tipRightStyle}">&nbsp;</span></div>').output({lineStyle:CKEDITOR.tools.writeCssText(CKEDITOR.tools.extend({},o,this.lineStyle,!0)),tipLeftStyle:CKEDITOR.tools.writeCssText(CKEDITOR.tools.extend({},s,{left:"0px","border-left-color":"red","border-width":"6px 0 6px 6px"},this.tipCss,this.tipLeftStyle,!0)),tipRightStyle:CKEDITOR.tools.writeCssText(CKEDITOR.tools.extend({},s,{right:"0px","border-right-color":"red","border-width":"6px 6px 6px 0"},this.tipCss,this.tipRightStyle,!0))})}function n(t){var e;return(e=t&&t.type==CKEDITOR.NODE_ELEMENT)&&(e=!(r[t.getComputedStyle("float")]||r[t.getAttribute("align")])),e&&!l[t.getComputedStyle("position")]}CKEDITOR.plugins.add("lineutils"),CKEDITOR.LINEUTILS_BEFORE=1,CKEDITOR.LINEUTILS_AFTER=2,CKEDITOR.LINEUTILS_INSIDE=4,t.prototype={start:function(t){var e,i,n,s,o=this,r=this.editor,l=this.doc,h=CKEDITOR.tools.eventsBuffer(50,function(){r.readOnly||"wysiwyg"!=r.mode||(o.relations={},(i=l.$.elementFromPoint(n,s))&&i.nodeType&&(e=new CKEDITOR.dom.element(i),o.traverseSearch(e),isNaN(n+s)||o.pixelSearch(e,n,s),t&&t(o.relations,n,s)))});this.listener=this.editable.attachListener(this.target,"mousemove",function(t){n=t.data.$.clientX,s=t.data.$.clientY,h.input()}),this.editable.attachListener(this.inline?this.editable:this.frame,"mouseout",function(){h.reset()})},stop:function(){this.listener&&this.listener.removeListener()},getRange:function(){var t={};return t[CKEDITOR.LINEUTILS_BEFORE]=CKEDITOR.POSITION_BEFORE_START,t[CKEDITOR.LINEUTILS_AFTER]=CKEDITOR.POSITION_AFTER_END,t[CKEDITOR.LINEUTILS_INSIDE]=CKEDITOR.POSITION_AFTER_START,function(e){var i=this.editor.createRange();return i.moveToPosition(this.relations[e.uid].element,t[e.type]),i}}(),store:function(){function t(t,e,i){var n=t.getUniqueId();n in i?i[n].type|=e:i[n]={element:t,type:e}}return function(e,i){var s;i&CKEDITOR.LINEUTILS_AFTER&&n(s=e.getNext())&&s.isVisible()&&(t(s,CKEDITOR.LINEUTILS_BEFORE,this.relations),i^=CKEDITOR.LINEUTILS_AFTER),i&CKEDITOR.LINEUTILS_INSIDE&&n(s=e.getFirst())&&s.isVisible()&&(t(s,CKEDITOR.LINEUTILS_BEFORE,this.relations),i^=CKEDITOR.LINEUTILS_INSIDE),t(e,i,this.relations)}}(),traverseSearch:function(t){var e,i,s;do if(s=t.$["data-cke-expando"],!(s&&s in this.relations)){if(t.equals(this.editable))break;if(n(t))for(e in this.lookups)(i=this.lookups[e](t))&&this.store(t,i)}while((!t||t.type!=CKEDITOR.NODE_ELEMENT||"true"!=t.getAttribute("contenteditable"))&&(t=t.getParent()))},pixelSearch:function(){function t(t,i,s,o,r){for(var l,h=0;r(s)&&(s+=o,25!=++h);)if(l=this.doc.$.elementFromPoint(i,s))if(l==t)h=0;else if(e(t,l)&&(h=0,n(l=new CKEDITOR.dom.element(l))))return l}var e=CKEDITOR.env.ie||CKEDITOR.env.webkit?function(t,e){return t.contains(e)}:function(t,e){return!!(16&t.compareDocumentPosition(e))};return function(e,i,s){var o=this.win.getViewPaneSize().height,r=t.call(this,e.$,i,s,-1,function(t){return 0<t});if(i=t.call(this,e.$,i,s,1,function(t){return t<o}),r)for(this.traverseSearch(r);!r.getParent().equals(e);)r=r.getParent();if(i)for(this.traverseSearch(i);!i.getParent().equals(e);)i=i.getParent();for(;(r||i)&&(r&&(r=r.getNext(n)),r&&!r.equals(i))&&(this.traverseSearch(r),i&&(i=i.getPrevious(n)),i&&!i.equals(r));)this.traverseSearch(i)}}(),greedySearch:function(){this.relations={};for(var t,e,i,s=this.editable.getElementsByTag("*"),o=0;t=s.getItem(o++);)if(!t.equals(this.editable)&&t.type==CKEDITOR.NODE_ELEMENT&&(t.hasAttribute("contenteditable")||!t.isReadOnly())&&n(t)&&t.isVisible())for(i in this.lookups)(e=this.lookups[i](t))&&this.store(t,e);return this.relations}},e.prototype={locate:function(){function t(t,e){var i=t.element[e===CKEDITOR.LINEUTILS_BEFORE?"getPrevious":"getNext"]();return i&&n(i)?(t.siblingRect=i.getClientRect(),e==CKEDITOR.LINEUTILS_BEFORE?(t.siblingRect.bottom+t.elementRect.top)/2:(t.elementRect.bottom+t.siblingRect.top)/2):e==CKEDITOR.LINEUTILS_BEFORE?t.elementRect.top:t.elementRect.bottom}return function(e){var i;this.locations={};for(var n in e)i=e[n],i.elementRect=i.element.getClientRect(),i.type&CKEDITOR.LINEUTILS_BEFORE&&this.store(n,CKEDITOR.LINEUTILS_BEFORE,t(i,CKEDITOR.LINEUTILS_BEFORE)),i.type&CKEDITOR.LINEUTILS_AFTER&&this.store(n,CKEDITOR.LINEUTILS_AFTER,t(i,CKEDITOR.LINEUTILS_AFTER)),i.type&CKEDITOR.LINEUTILS_INSIDE&&this.store(n,CKEDITOR.LINEUTILS_INSIDE,(i.elementRect.top+i.elementRect.bottom)/2);return this.locations}}(),sort:function(){var t,e,i,n;return function(s,o){t=this.locations,e=[];for(var r in t)for(var l in t[r])if(i=Math.abs(s-t[r][l]),e.length){for(n=0;n<e.length;n++)if(i<e[n].dist){e.splice(n,0,{uid:+r,type:l,dist:i});break}n==e.length&&e.push({uid:+r,type:l,dist:i})}else e.push({uid:+r,type:l,dist:i});return"undefined"!=typeof o?e.slice(0,o):e}}(),store:function(t,e,i){this.locations[t]||(this.locations[t]={}),this.locations[t][e]=i}};var s={display:"block",width:"0px",height:"0px","border-color":"transparent","border-style":"solid",position:"absolute",top:"-6px"},o={height:"0px","border-top":"1px dashed red",position:"absolute","z-index":9999};i.prototype={removeAll:function(){for(var t in this.hidden)this.hidden[t].remove(),delete this.hidden[t];for(t in this.visible)this.visible[t].remove(),delete this.visible[t]},hideLine:function(t){var e=t.getUniqueId();t.hide(),this.hidden[e]=t,delete this.visible[e]},showLine:function(t){var e=t.getUniqueId();t.show(),this.visible[e]=t,delete this.hidden[e]},hideVisible:function(){for(var t in this.visible)this.hideLine(this.visible[t])},placeLine:function(t,e){var i,n,s;if(i=this.getStyle(t.uid,t.type)){for(s in this.visible)if(this.visible[s].getCustomData("hash")!==this.hash){n=this.visible[s];break}if(!n)for(s in this.hidden)if(this.hidden[s].getCustomData("hash")!==this.hash){this.showLine(n=this.hidden[s]);break}n||this.showLine(n=this.addLine()),n.setCustomData("hash",this.hash),this.visible[n.getUniqueId()]=n,n.setStyles(i),e&&e(n)}},getStyle:function(t,e){var i=this.relations[t],n=this.locations[t][e],s={};if(s.width=i.siblingRect?Math.max(i.siblingRect.width,i.elementRect.width):i.elementRect.width,s.top=this.inline?n+this.winTopScroll.y-this.rect.relativeY:this.rect.top+this.winTopScroll.y+n,s.top-this.winTopScroll.y<this.rect.top||s.top-this.winTopScroll.y>this.rect.bottom)return!1;this.inline?s.left=i.elementRect.left-this.rect.relativeX:(0<i.elementRect.left?s.left=this.rect.left+i.elementRect.left:(s.width+=i.elementRect.left,s.left=this.rect.left),0<(i=s.left+s.width-(this.rect.left+this.winPane.width))&&(s.width-=i)),s.left+=this.winTopScroll.x;for(var o in s)s[o]=CKEDITOR.tools.cssLength(s[o]);return s},addLine:function(){var t=CKEDITOR.dom.element.createFromHtml(this.lineTpl);return t.appendTo(this.container),t},prepare:function(t,e){this.relations=t,this.locations=e,this.hash=Math.random()},cleanup:function(){var t,e;for(e in this.visible)t=this.visible[e],t.getCustomData("hash")!==this.hash&&this.hideLine(t)},queryViewport:function(){this.winPane=this.win.getViewPaneSize(),this.winTopScroll=this.winTop.getScrollPosition(),this.winTopPane=this.winTop.getViewPaneSize(),this.rect=this.getClientRect(this.inline?this.editable:this.frame)},getClientRect:function(t){t=t.getClientRect();var e=this.container.getDocumentPosition(),i=this.container.getComputedStyle("position");return t.relativeX=t.relativeY=0,"static"!=i&&(t.relativeY=e.y,t.relativeX=e.x,t.top-=t.relativeY,t.bottom-=t.relativeY,t.left-=t.relativeX,t.right-=t.relativeX),t}};var r={left:1,right:1,center:1},l={absolute:1,fixed:1};CKEDITOR.plugins.lineutils={finder:t,locator:e,liner:i}}();